"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const sdk_1 = require("@directus/sdk");
const exceptions_1 = require("../exceptions");
const storage_1 = require("../sdk/storage");
exports.default = (toolbox) => {
    toolbox.sdk = new sdk_1.Directus('http://localhost:8055');
    toolbox.options.feature('sdk', (builder) => {
        return builder.option('instance', {
            default: toolbox.config.project.data.instance || 'default',
            description: 'The instance name the command should use to talk to Directus api.',
        });
    });
    toolbox.events.on('command.execute.before', async (command, options) => {
        if (!command.settings?.features?.sdk) {
            return;
        }
        const instances = toolbox.config.system.data.instances;
        if (!(options.instance in instances)) {
            throw new exceptions_1.CLIRuntimeError(`Unknown instance: ${options.instance}`);
        }
        const instance = toolbox.config.system.data.instances[options.instance];
        const sdk = new sdk_1.Directus(instance.endpoint, {
            storage: new storage_1.InstanceStorage(options.instance, toolbox.config.system),
        });
        if (instance?.auth === 'token') {
            await sdk.auth.static(instance.data?.auth_token);
        }
        else if (instance?.auth === 'credentials') {
            await sdk.auth.refresh();
            toolbox.config.system.save();
        }
        toolbox.sdk = sdk;
    });
};
